name: AI News Digest

on:
  schedule:
    # 19:00 UTC = 5:00 AM AEDT (UTC+11, Oct-Apr) / 6:00 AM AEST (UTC+10, Apr-Oct)
    # Using AEDT offset so email arrives at 5am during daylight saving time.
    # During AEST (winter) it will arrive at 6am â€” a 1hr drift due to DST.
    - cron: "0 19 * * *"

  # Allows manual trigger from the Actions tab for testing
  workflow_dispatch:

jobs:
  send-digest:
    name: Fetch and Email AI News Digest
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write   # required to git push the updated public/index.html back to main

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install --upgrade pip && pip install -r requirements.txt

      - name: Run AI news digest
        env:
          GMAIL_USER:         ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python digest.py

      - name: Commit updated webpage
        run: |
          git config user.name "AI Digest Bot"
          git config user.email "actions@github.com"
          git add public/index.html
          git diff --staged --quiet || git commit -m "chore: update digest webpage [$(date -u '+%Y-%m-%d')]"
          git push

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: digest-failure-log-${{ github.run_id }}
          path: "*.log"
          if-no-files-found: ignore
          retention-days: 7
